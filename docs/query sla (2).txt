SELECT
    IFNULL(d.name, 'Sin departamento') AS departamento,
    TRIM(CONCAT(IFNULL(s.firstname,''), ' ', IFNULL(s.lastname,''))) AS agente,
    s_sla.name AS nombre_sla,

    YEAR(t.closed) AS anio,
    MONTH(t.closed) AS mes,
    CASE MONTH(t.closed)
        WHEN 1 THEN 'Enero'
        WHEN 2 THEN 'Febrero'
        WHEN 3 THEN 'Marzo'
        WHEN 4 THEN 'Abril'
        WHEN 5 THEN 'Mayo'
        WHEN 6 THEN 'Junio'
        WHEN 7 THEN 'Julio'
        WHEN 8 THEN 'Agosto'
        WHEN 9 THEN 'Septiembre'
        WHEN 10 THEN 'Octubre'
        WHEN 11 THEN 'Noviembre'
        WHEN 12 THEN 'Diciembre'
    END AS mes_nombre,

    COUNT(t.ticket_id) AS total_tickets,

    -- Tickets que cumplieron el SLA
    SUM(
        CASE 
            WHEN TIMESTAMPDIFF(HOUR, t.created, t.closed) <= s_sla.grace_period 
            THEN 1 ELSE 0 
        END
    ) AS tickets_sla_cumplido,

    -- Tickets fuera del SLA
    SUM(
        CASE 
            WHEN TIMESTAMPDIFF(HOUR, t.created, t.closed) > s_sla.grace_period 
            THEN 1 ELSE 0 
        END
    ) AS tickets_sla_vencido,

    -- Porcentaje de SLA cumplido, con formato 99.99 %
    CONCAT(
        FORMAT(
            SUM(
                CASE 
                    WHEN TIMESTAMPDIFF(HOUR, t.created, t.closed) <= s_sla.grace_period 
                    THEN 1 ELSE 0 
                END
            ) / NULLIF(COUNT(t.ticket_id), 0) * 100,
            2
        ), ' %'
    ) AS porcentaje_sla_cumplido,

    -- Tiempo promedio hasta primera respuesta (legible)
    CONCAT(
        FLOOR(AVG(
            CASE
                WHEN fr.first_response IS NOT NULL
                THEN TIMESTAMPDIFF(SECOND, t.created, fr.first_response)
            END
        ) / 86400), 'd ',
        LPAD(FLOOR(MOD(AVG(
            CASE
                WHEN fr.first_response IS NOT NULL
                THEN TIMESTAMPDIFF(SECOND, t.created, fr.first_response)
            END
        ), 86400) / 3600), 2, '0'), ':',
        LPAD(FLOOR(MOD(AVG(
            CASE
                WHEN fr.first_response IS NOT NULL
                THEN TIMESTAMPDIFF(SECOND, t.created, fr.first_response)
            END
        ), 3600) / 60), 2, '0')
    ) AS tiempo_promedio_primera_respuesta,

    -- Tiempo promedio total hasta resolución/cierre (legible)
    CONCAT(
        FLOOR(AVG(TIMESTAMPDIFF(SECOND, t.created, t.closed)) / 86400), 'd ',
        LPAD(FLOOR(MOD(AVG(TIMESTAMPDIFF(SECOND, t.created, t.closed)), 86400) / 3600), 2, '0'), ':',
        LPAD(FLOOR(MOD(AVG(TIMESTAMPDIFF(SECOND, t.created, t.closed)), 3600) / 60), 2, '0')
    ) AS tiempo_promedio_resolucion,

    -- Diferencia promedio vs límite SLA (margen o exceso)
    CASE
        WHEN AVG(s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed)) >= 0
        THEN CONCAT('Cumplió ', FORMAT(AVG(s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed)), 1), 'h antes')
        ELSE CONCAT('Se pasó ', FORMAT(ABS(AVG(s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed))), 1), 'h')
    END AS diferencia_sla_promedio

FROM ost_ticket t
LEFT JOIN ost_department d ON d.id = t.dept_id
LEFT JOIN ost_staff s ON s.staff_id = t.staff_id
LEFT JOIN ost_sla s_sla ON s_sla.id = t.sla_id

LEFT JOIN (
    SELECT 
        th.object_id AS ticket_id,
        MIN(te.created) AS first_response
    FROM ost_thread th
    INNER JOIN ost_thread_entry te ON te.thread_id = th.id
    WHERE te.type = 'R'
    GROUP BY th.object_id
) fr ON fr.ticket_id = t.ticket_id

WHERE
    t.closed IS NOT NULL
    AND d.name = 'Soporte IT'

GROUP BY
    anio, mes, departamento, agente, s_sla.name

ORDER BY
    anio DESC, mes DESC, departamento, agente;
