-- QUERY DETALLADA: SLA POR TICKET INDIVIDUAL
-- Muestra cada ticket con su diferencia exacta vs el límite SLA

SELECT
    t.number AS numero_ticket,
    IFNULL(d.name, 'Sin departamento') AS departamento,
    TRIM(CONCAT(IFNULL(s.firstname,''), ' ', IFNULL(s.lastname,''))) AS agente,
    s_sla.name AS nombre_sla,
    s_sla.grace_period AS limite_sla_horas,
    
    -- Fechas clave
    t.created AS fecha_creacion,
    t.closed AS fecha_cierre,
    
    -- Tiempo real de resolución
    TIMESTAMPDIFF(HOUR, t.created, t.closed) AS horas_resolucion_real,
    
    -- Tiempo de resolución legible (días:horas:minutos)
    CONCAT(
        FLOOR(TIMESTAMPDIFF(SECOND, t.created, t.closed) / 86400), 'd ',
        LPAD(FLOOR(MOD(TIMESTAMPDIFF(SECOND, t.created, t.closed), 86400) / 3600), 2, '0'), ':',
        LPAD(FLOOR(MOD(TIMESTAMPDIFF(SECOND, t.created, t.closed), 3600) / 60), 2, '0')
    ) AS tiempo_resolucion_legible,
    
    -- Diferencia vs límite SLA
    (s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed)) AS diferencia_horas,
    
    -- Estado del SLA (cumplido/vencido)
    CASE 
        WHEN TIMESTAMPDIFF(HOUR, t.created, t.closed) <= s_sla.grace_period 
        THEN 'Cumplido'
        ELSE 'Vencido'
    END AS estado_sla,
    
    -- Descripción de margen o exceso
    CASE
        WHEN (s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed)) >= 0
        THEN CONCAT('Cumplió ', FORMAT(s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed), 1), 'h antes')
        ELSE CONCAT('Se pasó ', FORMAT(ABS(s_sla.grace_period - TIMESTAMPDIFF(HOUR, t.created, t.closed)), 1), 'h')
    END AS diferencia_sla,
    
    -- Porcentaje del SLA utilizado
    CONCAT(
        FORMAT((TIMESTAMPDIFF(HOUR, t.created, t.closed) / s_sla.grace_period) * 100, 2),
        ' %'
    ) AS porcentaje_sla_utilizado,
    
    -- Tiempo de primera respuesta
    CASE
        WHEN fr.first_response IS NOT NULL
        THEN CONCAT(
            FLOOR(TIMESTAMPDIFF(SECOND, t.created, fr.first_response) / 3600), 'h ',
            LPAD(FLOOR(MOD(TIMESTAMPDIFF(SECOND, t.created, fr.first_response), 3600) / 60), 2, '0'), 'm'
        )
        ELSE 'Sin respuesta'
    END AS tiempo_primera_respuesta

FROM ost_ticket t
LEFT JOIN ost_department d ON d.id = t.dept_id
LEFT JOIN ost_staff s ON s.staff_id = t.staff_id
LEFT JOIN ost_sla s_sla ON s_sla.id = t.sla_id

LEFT JOIN (
    SELECT 
        th.object_id AS ticket_id,
        MIN(te.created) AS first_response
    FROM ost_thread th
    INNER JOIN ost_thread_entry te ON te.thread_id = th.id
    WHERE te.type = 'R'
    GROUP BY th.object_id
) fr ON fr.ticket_id = t.ticket_id

WHERE
    t.closed IS NOT NULL
    AND d.name = 'Soporte IT'
    AND t.closed >= DATE_SUB(NOW(), INTERVAL 3 MONTH)  -- Últimos 3 meses para rendimiento

ORDER BY
    t.closed DESC;

-- NOTAS:
-- 1. Esta query muestra TODOS los tickets individuales, no agregados
-- 2. Útil para análisis detallado, auditorías o reportes específicos
-- 3. Se puede filtrar por mes: AND YEAR(t.closed) = 2025 AND MONTH(t.closed) = 1
-- 4. Se puede filtrar por agente: AND s.staff_id = X
-- 5. Se puede filtrar por estado SLA: AND estado_sla = 'Vencido'
